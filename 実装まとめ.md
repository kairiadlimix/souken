# 図面チェックAIシステム 実装まとめ

## 実装完了項目

### ✅ Phase 1: MVP（最小実用製品）

1. **PDF解析モジュール** (`src/pdf_parser.py`)
   - PDFファイルの読み込み
   - テキスト抽出（ベクターPDF対応）
   - メタデータ抽出
   - PyPDF2とpdfplumberを使用

2. **チェックエンジン** (`src/checkers.py`)
   - 必須記載事項チェッカー
     - 図面番号
     - 図面名
     - 縮尺
     - 作成日
     - 作成者
   - 創建特有項目チェッカー
     - 外断熱仕様
     - 第一種換気システム
     - 釘ピッチ（150mm基準）
     - 隠蔽部分の施工方法

3. **メインスクリプト** (`src/main.py`)
   - コマンドライン実行可能
   - テキスト/JSON形式での結果出力
   - ファイル保存機能

4. **テストスクリプト** (`test_check.py`)
   - 実際のPDFファイルでテスト実行
   - デバッグ用

5. **ドキュメント**
   - 要件定義書
   - システム設計書
   - README

## テスト結果

### テスト実行結果
- ✅ PDF解析機能: 正常動作
- ✅ チェック機能: 正常動作
- ⚠️ スキャン図面: OCR未実装（Phase 2で対応）

### 検出された課題
1. **スキャン図面のテキスト抽出**
   - 現在のPDFは画像ベース（スキャンされたもの）
   - OCR機能が必要（Phase 2で実装予定）

2. **チェック項目の精度向上**
   - 実際の図面でテストして、パターンを追加する必要がある
   - チェックリストPDFから項目を抽出して追加

## 使用方法

### 基本的な使い方

```bash
# 図面をチェック
python -m src.main 図面ファイル.pdf

# JSON形式で出力
python -m src.main 図面ファイル.pdf --format json

# 結果をファイルに保存
python -m src.main 図面ファイル.pdf --output result.txt
```

### 出力例

```
================================================================================
チェック結果サマリー
================================================================================
総チェック数: 9
  OK: 0
  NG: 5
  警告: 4
  必須項目NG: 5
  全体ステータス: FAIL
================================================================================

指摘事項:
--------------------------------------------------------------------------------

【必須記載事項】
  1. ✗ 【必須】 図面番号
     図面番号が記載されていません
     → 図面番号を明記してください（例: A-001, S-001）

【創建特有項目】
  1. ✗ 【必須】 外断熱仕様
     外断熱仕様が記載されていません
     → 創建基準: 外断熱仕様を明記してください
```

## 次のステップ

### Phase 2: 機能拡張（4-6週間）

1. **OCR対応**
   - `pdf2image`でPDF→画像変換
   - `pytesseract`または`EasyOCR`でOCR処理
   - スキャン図面のテキスト抽出

2. **チェック項目の拡充**
   - チェックリストPDFから項目を抽出
   - 実際の図面を分析して追加項目を特定
   - 創建特有項目の詳細化

3. **図面要素認識**
   - OpenCVを使用した図面要素の認識
   - 線、文字、記号の検出

4. **詳細レポート生成**
   - PDFレポート生成（reportlab使用）
   - Excelレポート生成（openpyxl使用）
   - 図面へのマーキング機能

### Phase 3: 高度な機能（6-8週間）

1. **施工上の問題チェック**
   - 寸法の整合性チェック
   - 構造上の問題検出
   - 設備配置の合理性チェック

2. **図面間整合性チェック**
   - 複数図面の一括チェック
   - 平面図と立面図の整合性
   - 寸法の一貫性チェック

3. **Web UI実装**
   - FastAPIバックエンド
   - React/Vue.jsフロントエンド
   - ファイルアップロード機能
   - 結果表示機能

4. **データベース連携**
   - PostgreSQLでチェック結果を保存
   - 過去データの蓄積
   - 統計・分析機能

### Phase 4: 最適化・改善（継続的）

1. **学習機能**
   - 過去のチェック結果から学習
   - よくある不備パターンの自動検出
   - チェック精度の向上

2. **パフォーマンス改善**
   - 処理速度の最適化
   - 並列処理の実装

3. **UI/UX改善**
   - 使いやすさの向上
   - 視覚的な結果表示

## チェック項目の追加方法

新しいチェック項目を追加するには、`src/checkers.py`を編集します。

### 例: 新しいチェック項目の追加

```python
class SoukenSpecificChecker:
    def check(self, drawing_data: DrawingData) -> List[CheckResult]:
        results = []
        all_text = self._get_all_text(drawing_data)
        
        # 新しいチェック項目を追加
        if not self._has_new_item(all_text):
            results.append(CheckResult(
                category=self.category,
                item="新しい項目名",
                status=CheckStatus.NG,
                message="新しい項目が記載されていません",
                importance=Importance.REQUIRED,
                suggestion="新しい項目を明記してください"
            ))
        
        return results
    
    def _has_new_item(self, text: str) -> bool:
        """新しい項目の存在チェック"""
        patterns = [
            r'新しい項目のパターン1',
            r'新しい項目のパターン2',
        ]
        for pattern in patterns:
            if re.search(pattern, text, re.IGNORECASE):
                return True
        return False
```

## トラブルシューティング

### PDFからテキストが抽出できない
- スキャンされたPDF（画像ベース）の可能性
- Phase 2でOCR機能を実装予定
- 現在はベクターPDF（CADから出力されたもの）のみ対応

### チェック項目が検出されない
- 正規表現パターンを調整する必要がある
- 実際の図面の記載方法を確認してパターンを追加

### エラーが発生する
- `requirements.txt`のパッケージがインストールされているか確認
- PDFファイルが破損していないか確認

## 今後の改善点

1. **チェック項目の精度向上**
   - 実際の図面でテストしてパターンを追加
   - チェックリストPDFから項目を抽出

2. **OCR機能の実装**
   - スキャン図面に対応
   - OCR精度の向上

3. **図面要素認識の実装**
   - より高度なチェックが可能に

4. **Web UIの実装**
   - 使いやすさの向上
   - 複数ユーザーでの利用

## まとめ

Phase 1のMVPは正常に動作しています。基本的なPDF読み込みとテキスト抽出、必須項目と創建特有項目のチェックが実装されました。

次のPhase 2では、OCR機能の実装とチェック項目の拡充が主なタスクです。実際の図面でテストを重ねて、精度を向上させていきましょう。

